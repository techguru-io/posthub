FROM node:20-alpine3.19
ARG NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION
RUN apk add --no-cache g++ make py3-pip supervisor bash caddy
RUN npm --no-update-notifier --no-fund --global install pnpm@10.6.1 pm2

WORKDIR /app

COPY . /app
COPY var/docker/supervisord.conf /etc/supervisord.conf
COPY var/docker/Caddyfile /app/Caddyfile
COPY var/docker/supervisord/caddy.conf /etc/supervisor.d/caddy.conf
COPY var/docker/supervisord/backend.conf /etc/supervisor.d/backend.conf
COPY var/docker/supervisord/frontend.conf /etc/supervisor.d/frontend.conf
COPY var/docker/supervisord/workers.conf /etc/supervisor.d/workers.conf
COPY var/docker/supervisord/cron.conf /etc/supervisor.d/cron.conf
COPY var/docker/supervisord/migrate.conf /etc/supervisor.d/migrate.conf

RUN pnpm install
RUN pnpm run build

EXPOSE 5000

CMD ["supervisord", "-c", "/etc/supervisord.conf"]
